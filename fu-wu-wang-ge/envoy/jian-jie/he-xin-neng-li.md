# 核心能力

Envoy 的诞生源于以下理念：**网络对于应用程序来说应该是透明的，当网络和应用程序出现问题时，应该很容易确定问题的源头。**

当然要实现上述目标是非常困难的。Envoy 试图通过提供以下高级功能来实现这一目标：

**非侵入架构（进程外的架构）:** Envoy 是一个独立的进程，设计为伴随每个应用程序服务一起运行。所有 Envoy 实例形成一个透明的通信网格，每个应用程序通过 `localhost` 发送和接收消息，不需要知道网络拓扑。对服务的实现语言也完全无感知，这种模式也被称为 `Sidecar` 模式。

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
<mark style="color:blue;">**envoy核心功能列举**</mark>

<details>

<summary>L3/L4 过滤器架构</summary>

Envoy 的核心是一个 L3/L4 层的网络代理。可插拔的过滤器链机制允许编写不同的 TCP/UDP 代理任务的过滤器，并将其插入到主服务器中。而且已经内置支持了各种任务的过滤器，例如原始 TCP 代理、UDP 代理、HTTP 代理、TLS 客户端证书身份验证、Redis、MongoDB、Postgres 等。

Envoy 是一个高性能的开源网络代理软件，它设计用于服务网格架构中，以实现服务间通信的现代化管理。

1. **L3/L4 层网络代理**：这意味着 Envoy 在网络协议栈中的作用位于第三层（网络层，如 IP 协议）和第四层（传输层，如 TCP 和 UDP）。作为这些层次的代理，Envoy 能够处理网络数据包的路由和传输，包括连接管理、负载均衡以及协议特定的处理。
2. **可插拔的过滤器链机制**：Envoy 设计了一个高度灵活的架构，其中的核心是过滤器链。这个机制允许开发者根据需要编写特定功能的过滤器（比如日志记录、鉴权、数据转换等），然后将这些过滤器按需插入到处理请求的链条中。这种设计使得 Envoy 非常模块化和可扩展。
3. **TCP/UDP 代理任务的过滤器**：指明 Envoy 不仅限于 HTTP 协议，还能处理更底层的 TCP 和 UDP 协议的流量。这意味着它可以为几乎任何基于这些传输层协议的应用提供代理服务。
4. **内置支持的各种任务过滤器**：Envoy 提供了一系列预构建的过滤器，覆盖了广泛的应用场景，例如：
   1. **原始 TCP 代理和 UDP 代理**：直接转发 TCP 或 UDP 流量，适用于非 HTTP 协议的服务。
   2. **HTTP 代理**：处理 HTTP 和 HTTPS 流量，支持高级功能如路由、负载均衡、CORS 管理等。
   3. **TLS 客户端证书身份验证**：增强安全性，通过 TLS 协议验证客户端的身份。
   4. **Redis、MongoDB、Postgres**：特定于数据库协议的过滤器，可以理解并优化这些数据库协议的流量处理，比如缓存、协议升级或安全增强。

**举例说明**：

假设你有一个微服务架构的应用程序，其中包含多个服务，有的使用 HTTP 通信，有的使用 Redis 进行数据缓存交互。为了实现更好的监控、安全控制和故障隔离，你可以部署 Envoy 作为服务间的边车代理。

* 对于 HTTP 服务，你可以配置 Envoy 使用其内置的 HTTP 过滤器进行智能路由（比如基于请求内容路由到不同后端服务）、添加 TLS 加密来保护通信安全，以及利用客户端认证过滤器确保只有经过验证的服务才能访问敏感资源。
* 对于依赖 Redis 的服务，Envoy 提供了专门针对 Redis 协议的过滤器。这可以用来监控 Redis 通信的性能指标，或者在不改变服务代码的情况下，对 Redis 请求进行简单的缓存策略实施，提高响应速度。

通过这样的方式，Envoy 作为一个统一的基础设施层，不仅简化了服务间的通信管理，还提供了丰富的功能来满足现代分布式系统的需求。

</details>

<details>

<summary>HTTP L7 过滤器架构</summary>

HTTP 是现代应用程序架构的关键组件，因此 Envoy 支持了一个额外的 HTTP L7 过滤器层。HTTP 过滤器可以被插入到 HTTP 连接管理子系统中，执行不同的任务，如缓存、速率限制、路由/转发、嗅探 Amazon 的 DynamoDB 等。

HTTP L7 过滤器工作在 OSI 模型的第七层，也就是应用层，它们能够理解并操作 HTTP 协议的具体细节，从而实现在更高抽象层级上的功能定制。

1. **HTTP 是现代应用程序架构的关键组件**：意味着在云原生、微服务等现代架构中，HTTP 作为一种广泛使用的应用层协议，对于服务间通信、API 接口暴露、前端与后端交互等环节至关重要。
2. **Envoy 支持了一个额外的 HTTP L7 过滤器层**：Envoy 不仅仅是一个基础的网络层（L3/L4）代理，它还在 HTTP 协议级别提供了一整套过滤器机制。这一层的设计让 Envoy 能够更加智能和高效地处理 HTTP 请求和响应。
3. **HTTP 过滤器可以被插入到 HTTP 连接管理子系统中**：指的是在处理每一个 HTTP 请求/响应周期时，Envoy 允许用户根据需求选择并插入特定的 HTTP 过滤器。这些过滤器会在请求到达服务前或响应离开服务后执行，不影响服务本身的逻辑。
4. **执行不同的任务**，以下是几个具体的例子：
   1. **缓存**：Envoy 可以配置缓存过滤器，对某些频繁请求且不经常变更的数据进行缓存，减少对后端服务的调用，提升响应速度。例如，对于静态资源或商品列表查询，一旦获取到结果，Envoy 可直接从缓存返回，无需再次查询数据库。
   2. **速率限制**：通过速率限制过滤器，Envoy 能控制来自特定来源的请求频率，防止服务过载。比如，限制每分钟每个用户只能发出 100 次请求，超出则返回限流错误。
   3. **路由/转发**：路由过滤器可以根据请求的内容（如URL路径、HTTP头信息）动态地将请求路由到不同的后端服务。例如，将所有 `/api/v1/*` 的请求转发到旧版 API 服务集群，而 `/api/v2/*` 的请求则转发到新版服务集群。
   4. **嗅探 Amazon DynamoDB**：这是一个特例，虽然 Envoy 默认可能不直接提供针对 DynamoDB 的过滤器，但这句话想要表达的是，理论上可以通过自定义过滤器来实现对特定服务（如 DynamoDB）的特殊处理，比如添加请求头、记录日志、甚至是实现某种形式的客户端负载均衡逻辑。

</details>

<details>

<summary><strong>顶级的 HTTP/2 支持（一类或一等原生支持）</strong></summary>

在 HTTP 模式下运行时，Envoy 同时支持 HTTP/1.1 和 HTTP/2。Envoy 可以作为透明的 HTTP/1.1 到 HTTP/2 双向代理运行。这意味着可以连接任何组合的 HTTP/1.1 和 HTTP/2 客户端与目标服务器。**推荐的服务到服务配置在所有 Envoy 之间使用 HTTP/2 创建持久连接网格，请求和响应可以在该连接上进行多路复用。**

</details>

<details>

<summary><strong>HTTP/3 支持（目前处于 alpha 版）</strong></summary>

从 Envoy 1.19.0 版本开始，Envoy 现在支持上游和下游的 HTTP/3，而且可以在任何方向上进行 HTTP/1.1、HTTP/2 和 HTTP/3 之间的转换。

</details>

<details>

<summary><strong>HTTP L7 路由（7层路由）</strong></summary>

在 HTTP 模式下运行时，Envoy 支持路由子系统，该子系统能够根据路径、权限、内容类型、运行时值等路由和重定向请求。在使用 Envoy 作为前端/边缘代理时，此功能非常有用，但在构建服务到服务的网格时也可以利用它。

这个就有点类似于nginx里的location了。这个是代理程序基本上所要具有的基本能力。

</details>

<details>

<summary><strong>gRPC 支持</strong></summary>

gRPC 是 Google 的一个 RPC 框架，使用 HTTP/2 或更高版本作为底层多路复用传输。Envoy 支持用作 gRPC 请求和响应的路由和负载均衡基础所需的所有 HTTP/2 功能，这两个系统非常互补。

gRPC是目前最流行的一个gRPC框架。

</details>

<details>

<summary><strong>服务发现和动态配置</strong></summary>

Envoy 可以选择使用一组分层的动态配置 API 来进行集中管理。这些层向 Envoy 提供了关于后端集群中的主机、后端集群自身、HTTP 路由、监听套接字和加密材料的动态更新。对于更简单的部署，可以通过 DNS 解析（甚至完全跳过）来完成后端主机发现，并且进一步的层可以由静态配置文件替代。

<mark style="color:blue;">**nginx与envoy的区别**</mark>

nginx不具备服务发现和动态配置功能的能力 。

如果让nginx去支持服务发现，需要在docker模式下，可以利用consul template的形式，可以让它自动发现，然后自动刷新nginx配置，然后自动让它生效。

对Nginx，如果你改了一个配置(新增一个路由，或改了任何一个配置)，我们就要做一次<mark style="color:purple;">`nginx -s reload`</mark>操作。即使我们用consul,consul template，它其实原来还是调用<mark style="color:purple;">`nginx -s reload`</mark>这个操作。如果你的配置了比较大，或者应用服务比较多的话，那么nginx频繁去做reload，其性能还是有很大的一个损耗的。

但是，envoy不会，它原生就具有这个动态配置的能力。你修改过后，它就可以自动生效了。

</details>

<details>

<summary><strong>健康检查</strong></summary>

构建 Envoy 网格的推荐方法是将服务发现视为最终一致的过程。Envoy 包含一个健康检查子系统，可以选择对上游服务集群执行主动健康检查。然后，Envoy 使用服务发现和健康检查信息的结合来确定健康的负载均衡目标。Envoy 还通过异常值检测子系统支持被动健康检查。

有点类似于k8s里的service endpoints

</details>

<details>

<summary><strong>高级负载均衡</strong></summary>

分布式系统中不同组件之间的负载均衡是一个复杂的问题。由于 **Envoy 是一个独立的代理**而不是库，因此可以独立实现高级负载均衡以供任何应用程序访问。目前 Envoy 支持自动重试、熔断、通过外部速率限制服务进行全局速率限制、异常检测等。

这个是在我们的分布式系统里一定会用到的

</details>

<details>

<summary><strong>前端/边缘代理支持（南北向网关代理）</strong></summary>

在边缘使用相同的软件有很大的好处（可观察性、管理、相同的服务发现和负载均衡算法等）。 Envoy 的功能集使其非常适合作为大多数现代 Web 应用程序用例的边缘代理。这包括 **TLS 终止**、HTTP/1.1、HTTP/2 和 HTTP/3 支持以及 HTTP L7 路由。

</details>

<details>

<summary><strong>最佳的可观测性</strong></summary>

如上所述，Envoy 的主要目标是使网络透明化。但是，问题在网络层面和应用层面都可能会出现。Envoy 为所有子系统提供了强大的统计支持。目前支持的统计数据输出端是 `statsd`（以及兼容的提供程序），但是接入其他不同的统计数据输出端并不困难。统计数据也可以通过管理端口进行查看，Envoy 还支持通过第三方提供者进行分布式跟踪。

nginx具有的能⼒，envoy都⽀持。⽽且nginx不具备的能⼒，envoy也有很多。\
唯⼀⼀点是：ngnix的配置⼤家可能很得⼼应⼿。envoy的配置确实是有⼀点点⼩复杂。

</details>
{% endhint %}

