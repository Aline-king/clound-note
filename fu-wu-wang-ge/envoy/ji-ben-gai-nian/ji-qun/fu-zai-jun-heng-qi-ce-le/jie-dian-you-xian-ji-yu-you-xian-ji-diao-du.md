# 节点优先级与优先级调度

在Envoy中，<mark style="color:blue;">**节点优先级（Priority）**</mark>和<mark style="color:yellow;">**优先级调度（Priority Scheduling）**</mark>是负载均衡的一部分，用于管理和调度上游集群（upstream clusters）中的不同优先级节点。当上游集群中包含多个节点时，可以根据节点的重要性和健康状况将它们分配到不同的优先级，以确保关键节点优先处理请求，提高系统的可靠性和可用性。

## 一、 节点优先级 <a href="#yi-jie-dian-you-xian-ji-2" id="yi-jie-dian-you-xian-ji-2"></a>

Envoy允许将上游节点分配到不同的优先级组。每个优先级组中的节点会根据其健康状况和优先级进行调度。常见的优先级分为：

1. **DEFAULT**：默认优先级，适用于大多数节点。
2. **HIGH**：高优先级，通常用于备用节点或更关键的节点。

在Envoy中，优先级的数值越低，优先级越高。因此，`priority: 0` 确实是最高优先级。节点优先级的数值从0开始递增，数值越小代表优先级越高，数值越大代表优先级越低。

* **最高优先级**：`priority: 0` 是最高优先级，当这些节点可用时，流量会优先路由到这些节点。
* **次高优先级**：`priority: 1` 是次高优先级，当最高优先级节点不可用时，流量会被路由到这些节点。
* **以此类推**：后续优先级的节点依次类推，当更高优先级的节点不可用时，流量会继续向次高优先级的节点转移。

## 二、 优先级调度 <a href="#er-you-xian-ji-diao-du-7" id="er-you-xian-ji-diao-du-7"></a>

优先级调度机制确保在默认优先级的节点不可用或过载时，将流量路由到高优先级节点。这种调度策略有助于提高服务的容错性和可用性。例如，当默认优先级的所有节点都不可用时，Envoy会自动将流量转移到次高优先级的节点。

**配置示例**

以下是配置节点优先级和优先级调度的示例：

```yaml
static_resources:
  clusters:
  - name: example_service
    connect_timeout: 0.25s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: example_service
      endpoints:
      - priority: 0
        lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: primary.example.com
                port_value: 80
      - priority: 1
        lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: secondary.example.com
                port_value: 80
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 100
        max_pending_requests: 1000
        max_requests: 5000
      - priority: HIGH
        max_connections: 200
        max_pending_requests: 2000
        max_requests: 10000
```

**配置项解释**

* **priority**：指定节点的优先级。`priority: 0`表示默认优先级，`priority: 1`表示次高优先级。
* **lb\_endpoints**：列出了属于该优先级组的所有节点。
* **circuit\_breakers**：为不同优先级的节点配置熔断器参数，以控制最大连接数、挂起请求数和请求数。

## 三、 优先级调度的工作原理 <a href="#san-you-xian-ji-diao-du-de-gong-zuo-yuan-li-14" id="san-you-xian-ji-diao-du-de-gong-zuo-yuan-li-14"></a>

### 3.1 基本工作原理 <a href="#id-31-ji-ben-gong-zuo-yuan-li-15" id="id-31-ji-ben-gong-zuo-yuan-li-15"></a>

1. **默认优先级调度**：Envoy首先会尝试将请求路由到默认优先级（priority: 0）组中的节点。
2. **次高优先级调度**：如果默认优先级组中的所有节点都不可用或过载，Envoy会自动将请求转移到次高优先级（priority: 1）组中的节点。
3. **健康检查**：通过健康检查，Envoy持续监控各个优先级组中的节点状态，确保在默认优先级组恢复健康后，流量可以回流到默认优先级组。

### 3.2 深层次工作原理 <a href="#id-32-shen-ceng-ci-gong-zuo-yuan-li-17" id="id-32-shen-ceng-ci-gong-zuo-yuan-li-17"></a>

Envoy是一种智能的网络代理，常用于管理和分配应用程序之间的网络流量，就像一个交通指挥员，确保数据流在不同服务器之间顺畅地流动。

**1. LocalityLbEndpoints（位置端点）**

LocalityLbEndpoints可以理解为一组在相同地理位置（比如同一个城市或数据中心）中的服务器。每组服务器都有相同的优先级和负载均衡权重。

**2. Locality（位置）**

Locality是服务器所在的地理位置，可以分为不同层级，例如：

* **地域（region）**：一个大区域，比如中国。
* **区域（zone）**：一个较小的区域，比如北京。
* **子区域（sub\_zone）**：更小的区域，比如北京的某个具体机房。

**3. Load Balancing Weight（负载均衡权重）**

负载均衡权重就像每组服务器的工作能力分数。权重越高，这组服务器分到的工作（流量）就越多。比如，北京有两组服务器A和B，如果A的权重是5，B的权重是3，那么A会分到更多的工作。

**4. Priority（优先级）**

优先级类似于紧急处理顺序。优先级为0的是最优先处理的服务器，只有当这些服务器全部出问题时，才会去用优先级为1的服务器。

**举个例子：**

假设你有一个网站，有两个数据中心，一个在北京，一个在上海，每个数据中心有几个服务器。北京的数据中心优先级是0，上海的数据中心优先级是1。这样，当所有服务器都正常工作时，流量会优先发送到北京的数据中心。当北京的数据中心不可用时，流量会自动转移到上海的数据中心。



<details>

<summary><strong>5. 超配因子（Overprovisioning Factor）</strong></summary>

超配因子是为了在部分服务器故障时，仍将更多的流量分配给剩余健康的服务器。

例如，如果某组服务器的超配因子为1.4，当其中20%的服务器故障时，仍会保留所有流量在当前组，只有当健康服务器少于72%时，才会转移部分流量到次优先级的服务器。



</details>

**举个例子：**

假设北京有3个服务器，1个故障了，剩下2个健康的。此时健康比例为2/3 ≈ 66.67%。如果超配因子是1.4，健康评分为66.67% \* 1.4 ≈ 93.33%，所以93.33%的流量会继续留在北京，只有6.67%的流量会转移到上海。

* 计算思路
  * 计算公式：转移的流量 = 100% - 健康的端点比例 \* 超配因子。
  * 例如，对于1.4的超配因子来说，20%的故障比例时，所有流量仍将保留在当前组；当健康的端点比例低于72%时，才会有部分流量转移至次优先级端点。
  * 健康评分：一个优先级当前处理流量的能力也称为健康评分（健康主机比例 \* 超配因子，上限为100%）。
* 关于计算过程

要计算当第一个region中某个节点不可用时，超配因子为1.4的情况下，应该如何迁移流量，我们需要首先计算健康节点的比例以及根据公式计算转移的流量。

**情况描述：**

* 第一个region有3个节点，当前1个节点不可用，即2个节点健康。
* 第二个region有2个节点，全部健康。
* 超配因子为1.4。

**计算步骤：**

1. **计算健康节点比例**：\
   第一个region的健康节点比例 = 健康节点数 / 总节点数 = 2/3 ≈ 0.6667（即66.67%）。
2. **计算健康评分**：\
   健康评分 = 健康节点比例 \* 超配因子\
   \= 0.6667 \* 1.4\
   ≈ 0.9333（即93.33%，上限为100%）
3. **确定是否需要转移流量**：\
   因为健康评分大于72%，所以在这个超配因子1.4的情况下，不会立即转移流量到第二个region。当健康评分低于72%时才会转移。
4. **计算转移的流量**：\
   转移的流量 = 100% - 健康节点比例 \* 超配因子\
   \= 100% - 0.6667 \* 1.4\
   \= 100% - 93.33%\
   \= 6.67%

**结论：**

当第一个region中的一个节点不可用时（总共3个节点，1个不可用），且超配因子为1.4时，健康评分为93.33%。因此，在这种情况下，**仅6.67%的流量将会转移到第二个region**，其余93.33%的流量仍然会分配给第一个region中的健康节点。

**关于72%值的计算**

72%的计算是基于健康评分和超配因子的关系。我们可以通过以下步骤来详细解释这个计算过程：

**计算逻辑**

健康评分 = 健康节点比例 × 超配因子

当健康节点比例达到某个临界值时，如果超配因子乘以这个比例的结果刚好等于100%，那么这个临界值就是我们需要找的72%。换句话说，我们要找到健康节点比例的一个值，使得健康评分等于100%。

**计算步骤**

1. **设定健康评分的临界值为100%**\
   我们需要找到一个健康节点比例，使得健康评分等于100%。
2. **使用健康评分公式**\
   健康评分 = 健康节点比例 × 超配因子
3. **代入健康评分为100%**\
   100% = 健康节点比例 × 1.4
4. **解方程求健康节点比例**\
   健康节点比例 = 100% / 1.4\
   \= 1 / 1.4\
   ≈ 0.7143（即71.43%）

为了简化计算，通常将其四舍五入为72%。

**6. Panic阈值（恐慌阈值）**

Panic阈值是一个关键点，当健康的服务器比例低于这个阈值时，Envoy会忽略健康状态，把流量分配给所有服务器，防止系统完全崩溃。默认的Panic阈值是50%。

**举个例子：**

如果北京的数据中心有3个服务器，只有1个是健康的（健康比例为1/3 ≈ 33.33%），这低于50%的Panic阈值，Envoy会忽略健康状态，把流量分配给所有服务器（包括不健康的），确保服务尽可能不中断。

**总结一下这些概念：**

* **LocalityLbEndpoints**：一组位于相同地理位置的服务器。
* **Locality**：服务器的地理位置，从大到小分为地域、区域和子区域。
* **负载均衡权重**：决定流量分配比例的分数。
* **优先级**：决定服务器使用顺序的等级。
* **超配因子**：在部分服务器故障时保留更多流量的机制。
* **Panic阈值**：在健康服务器比例过低时，把流量分配给所有服务器的机制。

通过这些概念和机制，Envoy可以智能地管理网络流量，确保在各种情况下系统的稳定性和高可用性。



<figure><img src="../../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>
