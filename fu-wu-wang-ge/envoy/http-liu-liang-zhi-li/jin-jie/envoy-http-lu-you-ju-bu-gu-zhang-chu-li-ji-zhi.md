# Envoy HTTP路由局部故障处理机制

局部故障处理方法

{% tabs %}
{% tab title="重试（Retry）" %}
在分布式环境中，对远程资源和服务的调用可能会因瞬态故障（短时间内可自行恢复的故障）而失败。一般情况下，重试机制可以解决此类问题。常见的瞬态故障包括网络连接速度慢、超时、资源过量使用或暂时不可用等。

* **场景**: 网络连接速度慢导致请求失败。
* **解决方案**: 配置重试机制，允许在请求失败时自动重试几次，以增加成功的机会
{% endtab %}

{% tab title="超时（Timeout）" %}
此外，还存在一些因意外事件导致的故障，这类故障可能需要较长时间才能恢复，其严重性范围从部分连接中断到服务完全失败。连续重试和长时间等待对这种场景没有太大意义。应用程序应迅速接受操作已失败的事实，并主动处理该失败。

可以将调用服务的操作配置为“超时”，若服务在设定的超时时长内未能响应，则返回失败消息。

* **场景**: 某服务由于意外事件需要较长时间才能恢复。
* **解决方案**: 设置操作超时时间，如果服务在超时时间内未能响应，则立即返回失败消息，避免长时间等待。
{% endtab %}

{% tab title="断路器（Circuit Breaker）" %}
当服务非常繁忙时，系统某一部分的故障可能会导致级联故障。对此，简单的超时策略可能导致同一操作的许多并发请求被阻止，直到超时耗尽。这些被阻止的请求可能占用关键系统资源，例如内存、线程和数据库连接等。这类资源的耗尽可能导致使用相同系统的其他部分出现故障。

因此，此时最好立即使操作失败，而不是等待超时，从而防止资源被耗尽。

* **场景**: 服务过于繁忙，导致系统资源耗尽，进而引发级联故障。
* **解决方案**: 实施断路器模式，当检测到大量请求失败时，立即中断进一步的请求，快速返回失败结果，防止系统资源被耗尽。
{% endtab %}
{% endtabs %}

这些局部故障处理方法可以有效提高系统的稳定性和可靠性，防止因单点故障导致系统崩溃。

### 请求重试策略 <a href="#id-92-qing-qiu-chong-shi-ce-le-306" id="id-92-qing-qiu-chong-shi-ce-le-306"></a>

下面介绍请求重试（Retry）的策略和方法，用于在分布式应用环境中处理瞬态故障。

**瞬态故障概述**

在分布式应用环境中，瞬态故障并不罕见。常见的故障包括与组件和服务的网络连接暂时丢失、服务暂时不可用或服务繁忙时发生的超时等。这类故障通常能够自我纠正，如果在适当的延迟后重复此前触发故障的请求操作，通常会成功。

**请求重试的策略**

{% tabs %}
{% tab title="重试 (Retry)" %}
* **描述**: 对于暂时性或不常见类型的故障，反复请求通常可以获得正确结果。
* **示例**: 在网络连接偶尔丢失的情况下，通过重试操作，可以重新建立连接并完成请求。
{% endtab %}

{% tab title="延迟后重试 (Retry with Delay)" %}
* **描述**: 若故障是由较常见的连接问题或服务繁忙引起的，应用程序需要等待适当的时间，然后再重试请求，以便让系统有时间纠正问题或清除积压工作。
* **示例**: 在服务暂时不可用的情况下，可以在等待几秒钟后再重试请求，以避免立即重试导致的高负载。
{% endtab %}

{% tab title="取消 (Cancel)" %}
* **描述**: 对于并非暂时性故障，或即便反复请求也不太可能成功的情况，应用程序应取消该操作并报告异常。取消类似于中断操作。
* **示例**: 如果服务完全不可用，应用程序应取消请求并通知用户或系统管理员，而不是不断重试。
{% endtab %}
{% endtabs %}

**重试策略的优化**

为了处理更常见的瞬态故障，应合理设定重试之间的时间间隔，以尽可能均匀地分散来自应用程序多个实例的请求，减少服务持续超载的可能性。如果应用程序的许多实例不断重试请求，服务的恢复将花费更长时间。

可以通过在重试尝试之间增加延迟的方式重复此过程，直到达到最大请求次数为止。延迟可以采用增量或指数方式增加，具体取决于故障的类型及其在此期间得到纠正的可能性。

* **增量延迟重试**:
  * **场景**: 连接到数据库时，如果连接失败，则每次重试的延迟时间增加500毫秒。
  * **策略**: 第一次重试延迟500毫秒，第二次重试延迟1000毫秒，依此类推，直到达到最大重试次数。
* **指数延迟重试**:
  * **场景**: 调用外部API时，如果调用失败，则每次重试的延迟时间加倍。
  * **策略**: 第一次重试延迟1秒，第二次重试延迟2秒，第三次重试延迟4秒，依此类推，直到达到最大重试次数。

通过这些策略，可以显著提高应用程序在面对瞬态故障时的稳定性和可靠性。

{% hint style="info" %}
**请求重试的注意事项**

<details>

<summary><strong>匹配业务需求和故障性质</strong></summary>

* <mark style="color:purple;">**快速失败**</mark>: 对于非关键操作，最好快速失败，而不是多次重试，避免影响应用程序的吞吐量。
* <mark style="color:purple;">**交互式Web应用程序**</mark>: 在较短延迟后进行少量重试，之后向用户显示适当的消息，如“请稍后重试”。
* <mark style="color:purple;">**批处理应用**</mark>: 增加重试次数更为合适，但重试之间的延迟应成倍或指数级增加。

</details>

<details>

<summary><strong>防止过度重试</strong></summary>

* **大量重试失败后**: 防止进一步请求进入同一服务，并立即报告失败。
* **断路器功能**: 在一定的过期时长后，允许服务暂时通过一个或多个请求，以查看是否成功。

</details>

<details>

<summary><strong>考虑操作的幂等性</strong></summary>

* **幂等操作**: 重试本质上是安全的。
* **非幂等操作**: 重试可能导致操作被执行多次，产生意外的副作用。

</details>

<details>

<summary><strong>根据异常类型调整重试策略</strong></summary>

* **迅速解决的故障**: 某些异常可能很快解决。
* **持续较长时间的故障**: 某些异常可能持续较长时间，因此重试间隔需要调整。

</details>

<details>

<summary><strong>确保重试代码的全面测试</strong></summary>

* **全面测试**: 确保所有重试代码已针对各种故障情况进行了全面测试。
* **性能和可靠性**: 检查重试代码是否影响应用程序的性能或可靠性。
* **资源负担**: 确保重试不会对服务和资源造成过多负担。
* **竞争状况和瓶颈**: 检查重试机制是否会引发竞争状况和瓶颈。

</details>
{% endhint %}

**策略示例**

1. **快速失败**:
   * **场景**: 用户尝试提交订单时，如果订单服务繁忙。
   * **策略**: 快速失败并提示用户“请稍后重试”，而不是多次重试以避免影响整体系统性能。
2. **幂等性操作**:
   * **场景**: 更新用户地址的请求。
   * **策略**: 因为更新地址是幂等操作，可以安全地进行多次重试。
3. **根据异常类型调整重试间隔**:
   * **场景**: 调用外部API时，网络偶尔中断。
   * **策略**: 如果是网络超时异常，可以迅速重试；如果是服务不可用异常，则延长重试间隔时间。

通过这些注意事项，可以更有效地实施请求重试策略，提高系统的稳定性和可靠性。

#### **Envoy HTTP请求重试（route.RetryPolicy）**

**Envoy的重试配置**

Envoy支持在虚拟主机及路由级别配置重试，并且可以通过特定请求的标头配置重试。路由级别重试的优先级高于虚拟主机级别。

**重试条件**

```json
retry_policy: {
  "retry_on": "...", // 重试发生的条件，同 x-envoy-retry-on 和 x-envoy-retry-grpc-on 标头相同
  "num_retries": "{...}", // 重试次数，默认值为1，同 x-envoy-max-retries 标头相同，采用二者中配置的最大值
  "per_try_timeout": "{...}", // 每次重试时同上游端点建立连接的超时时长
  "retry_priority": "{...}", // 配置重试优先级策略
  "retry_host_predicate": [], // 重试时使用的主机断言列表
  "retry_options_predicates": [], 
  "host_selection_retry_max_attempts": "{...}", // 允许尝试重新选择主机的最大次数，默认为1
  "retriable_status_codes": [], // 触发重试操作的HTTP状态码列表
  "retry_back_off": "{...}", // 控制回退算法的参数
  "rate_limited_retry_back_off": "{...}", // 控制重试回退策略的参数
  "retriable_headers": [], // 触发重试的HTTP响应标头列表
  "retriable_request_headers": [] // 必须在用于重试的请求报文中使用的HTTP标头列表
}
```

**重试条件（与x-envoy-retry-on标头相关）**

* **5xx**: 上游主机返回5xx响应码或根本未予响应（断开/重置/读取超时）。
* **gateway-error**: 网关错误，仅对502、503或504响应码进行重试。
* **connection-failure**: 在TCP级别与上游服务建立连接失败时进行重试。
* **retriable-4xx**: 上游服务器返回可重复的4xx响应码时进行重试。
* **refused-stream**: 上游服务器使用REFUSED-STREAM错误重置时进行重试。
* **reset**: 上游主机完全不响应时（断开/重置/读取超时）进行重试。
* **retriable-headers**: 上游服务器响应报文匹配重试策略或x-envoy-retriable-header-name标头中的任何标头时进行重试。
* **envoy-ratelimited**: 标头中存在x-envoy-ratelimited时进行重试。

**重试条件（与x-envoy-retry-grpc-on标头相关）**

* **cancelled**: gRPC应答标头中的状态码是“cancelled”时进行重试。
* **deadline-exceeded**: gRPC应答标头中的状态码是“deadline-exceeded”时进行重试。
* **internal**: gRPC应答标头中的状态码是“internal”时进行重试。
* **resource-exhausted**: gRPC应答标头中的状态码是“resource-exhausted”时进行重试。
* **unavailable**: gRPC应答标头中的状态码是“unavailable”时进行重试。

默认情况下，Envoy不会进行任何类型的重试操作，除非明确配置。

**重试和超时机制配置示例**

```json
routes:
- match:
    prefix: "/service/blue"
  route:
    cluster: blue_abort
    retry_policy:
      retry_on: "5xx"
      num_retries: 3
- match:
    prefix: "/service/red"
  route:
    cluster: red_delay
    timeout: 10s
- match:
    prefix: "/service/green"
  route:
    cluster: green
- match:
    prefix: "/service/colors"
  route:
    cluster: mycluster
    retry_policy:
      retry_on: "5xx"
      num_retries: 3
    timeout: 1s
```

**解释**

* **路由1**: 使用重试策略，重试条件为“5xx”，最大重试次数为3。
* **路由2**: 使用超时机制，超时时长为10秒。
* **路由3**: 没有重试或超时配置。
* **路由4**: 使用重试策略和超时机制，重试条件为“5xx”，最大重试次数为3，超时时长为1秒。
